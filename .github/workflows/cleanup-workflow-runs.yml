name: Cleanup old workflow runs

on:
  schedule:
    # Daily at 03:25 UTC (adjust as needed)
    - cron: '25 3 * * *'
  workflow_dispatch:

permissions:
  actions: write
  contents: read

concurrency:
  group: cleanup-workflow-runs
  cancel-in-progress: true

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete workflow runs older than 3 days (keep latest per workflow)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          RETAIN_DAYS: '3'
        run: |
          python - <<'PY'
          import json
          import os
          import sys
          import urllib.request
          from datetime import datetime, timedelta, timezone

          token = os.environ.get('GITHUB_TOKEN')
          repo = os.environ.get('GITHUB_REPOSITORY')
          retain_days = int(os.environ.get('RETAIN_DAYS', '3'))

          if not token or not repo or '/' not in repo:
            print('Missing required env vars (GITHUB_TOKEN, GITHUB_REPOSITORY).', file=sys.stderr)
            sys.exit(1)

          base = 'https://api.github.com'
          headers = {
            'Authorization': f'Bearer {token}',
            'Accept': 'application/vnd.github+json',
            'X-GitHub-Api-Version': '2022-11-28',
            'User-Agent': 'cleanup-workflow-runs',
          }

          def request(method: str, url: str):
            req = urllib.request.Request(url, method=method, headers=headers)
            try:
              with urllib.request.urlopen(req) as resp:
                body = resp.read()
                if not body:
                  return None
                return json.loads(body.decode('utf-8'))
            except urllib.error.HTTPError as e:
              detail = e.read().decode('utf-8', errors='replace')
              print(f'HTTP {e.code} {method} {url}: {detail}', file=sys.stderr)
              raise

          cutoff = datetime.now(timezone.utc) - timedelta(days=retain_days)
          print(f'Cutoff: {cutoff.isoformat()} (retain_days={retain_days})')

          workflows_url = f'{base}/repos/{repo}/actions/workflows?per_page=100'
          workflows = request('GET', workflows_url) or {}

          for wf in workflows.get('workflows', []):
            wf_id = wf.get('id')
            wf_name = wf.get('name', str(wf_id))
            if not wf_id:
              continue

            print(f'---')
            print(f'Workflow: {wf_name} (id={wf_id})')

            # Determine the newest run (keep it regardless of age)
            first_page_url = f'{base}/repos/{repo}/actions/workflows/{wf_id}/runs?per_page=100&page=1'
            first = request('GET', first_page_url) or {}
            runs_first = first.get('workflow_runs', [])
            if not runs_first:
              print('No runs.')
              continue

            keep_run_id = runs_first[0].get('id')
            print(f'Keeping latest run id={keep_run_id}')

            deleted = 0
            page = 1
            while True:
              runs_url = f'{base}/repos/{repo}/actions/workflows/{wf_id}/runs?per_page=100&page={page}'
              data = request('GET', runs_url) or {}
              runs = data.get('workflow_runs', [])
              if not runs:
                break

              for run in runs:
                run_id = run.get('id')
                if not run_id or run_id == keep_run_id:
                  continue

                status = run.get('status')
                if status in ('queued', 'in_progress'):
                  continue

                created_at = run.get('created_at')
                if not created_at:
                  continue

                created_dt = datetime.fromisoformat(created_at.replace('Z', '+00:00'))
                if created_dt >= cutoff:
                  continue

                delete_url = f'{base}/repos/{repo}/actions/runs/{run_id}'
                request('DELETE', delete_url)
                deleted += 1

              page += 1
              # Hard safety cap to avoid infinite loops
              if page > 50:
                print('Reached page limit; stopping for safety.', file=sys.stderr)
                break

            print(f'Deleted {deleted} old runs for workflow: {wf_name}')

          print('Done.')
          PY
